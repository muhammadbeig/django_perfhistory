{% extends "base_index.html" %}
{% block content %}


    
<script type="text/javascript">

        function removeTagTable(pid)
        {
            $("#tagTable_"+pid).remove();
        }
        function createTable(pid, object_list){
             
            mytable = $('<table></table>').attr({ id: "tagTable_"+pid,class: ["table",  "table-bordered", "table-striped"].join(' ') });

            var tr = [];
            if (object_list.length > 0)
            {
                // console.log('object_list'+object_list);
                // console.log('zero-th object'+object_list[0]["tag_name"]);
                
                $('<th></th>').text("#").attr({ align: "center"}).appendTo(mytable);
                $('<th></th>').text("Name").attr({ align: "center"}).appendTo(mytable);
                $('<th></th>').text("Description").attr({ align: "center"}).appendTo(mytable);    
                for (var i=0; i<object_list.length; i++)
                {
                    tagId = object_list[i]["tag_id"]
                    var row = $('<tr class="clickable-tagrow" data-tid='+tagId+' data-href="/perfhistory/project/'+pid+'/tag/'+tagId+'/result" style="cursor: pointer"></tr>').appendTo(mytable);
                    
                    // $('<a href=""></a>').appendTo(row);
                    $('<td></td>').text(object_list[i]["tag_id"]).appendTo(row); 
                    $('<td></td>').text(object_list[i]["tag_name"]).appendTo(row); 
                    $('<td></td>').text(object_list[i]["tag_description"]).appendTo(row); 
                }

                // console.log("TTTTT:"+mytable.html());
                $('#collapse_'+pid).children('.panel-body').children('#tableplaceholder').append(mytable);  

            }  
          
        }


        function ajax_get_tags_in_project (project_id)
        {
            // var pid=e.currentTarget.dataset.pid;
                        // console.log(pid);
                        var jqxhr = $.get( "/perfhistory/project/"+project_id+"/getTags",function(f) 
                        {
                          // console.log('dats', f );
                          removeTagTable(project_id);
                          createTable(project_id, f);

                        })
                        .done(function(d) {
                            // console.log( d );
                        })
                        .fail(function(e) {
                            // console.log( "error",e );
                        })
                        .always(function() {
                            // console.log( "finished" );
                        });

                    // Perform other work here ...

                    // Set another completion function for the request above
                    jqxhr.always(function() {
                      // console.log( "second finished" );
                    });

                    
        }

        

        $(document).ready(function() {

            var originalColor;

                $('div#tableplaceholder').on('mouseenter', '.clickable-tagrow', function() {
                        // $(this).addClass('hover');
                        // console.log('current color:'+ $(this).css( "background" ))
                        originalColor = $(this).css( "background" )
                        $(this).css("background","");
                        $(this).css("background","lightblue");

                        // console.log("mouse enter");

                    });
                $('div#tableplaceholder').on('mouseleave', '.clickable-tagrow', function() {
                        // $(this).removeClass('hover');
                        $(this).css("background",originalColor);
                        // console.log("mouseleave");
                    });

                $("div#tableplaceholder").on('click', '.clickable-tagrow',  function() {

                    console.log("row clicked: " + $(this).data("href"));
                    href = $(this).data("href")
                    window.location.href = href
                    // $.get( href, function( data ) {
                    //       $( ".result" ).html( data );
                    //       // alert( "Load was performed." );
                    //     });
                });



        });
</script>

<script type="text/javascript">
        $(function()
        {
            $('.collapsed').on('click', function(event)
                { 
                    // console.log("collapsed clicked");
                    ajax_get_tags_in_project(event.currentTarget.dataset.pid)
                });

        });


          $(document).ready(function() 
          {
            
                
            $("[id^=tagform_]").submit(function(e,data)
            {
                var projectid=e.currentTarget.dataset.projectId;
                var csrftoken = getCookie('csrftoken');

                e.preventDefault();
                formdata = {}
                for (i=0; i<e.currentTarget.length-1; i++)
                {
                    if (e.currentTarget[i].value)
                        formdata[String(e.currentTarget[i].name)] = e.currentTarget[i].value
                }

                $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
                });
                create_tag(projectid, formdata);
                this.reset();
            });

        });

        function create_tag(projectid, data)
        {
            var jqxhr = $.post( "/perfhistory/project/"+projectid+"/createTag",data )

                jqxhr.success (function(data) 
                {
                    // console.log("Success" );
                    // console.log(data);
                    
                    if (data['status'])
                    {
                        var projectid=data['project_id'];
                        // console.log('result is there');
                        removeTagTable(projectid);
                        ajax_get_tags_in_project(projectid);

                    }


                });
                jqxhr.done(function() 
                {
                    
                    // console.log("second success" );
                 });
                 jqxhr.fail(function() 
                 {
                   // console.log("Error" );
                 });
                jqxhr.always(function(data) 
                {
                    // console.log("Finished" );
                    // console.log(data);
                });
        }
            

        function getCookie(name) 
        {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function csrfSafeMethod(method) 
        {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }        
</script>




<div id="page-wrapper">

                <!-- Page Heading -->
                <div class="row">
                    <div class="col-lg-12">
                        <h1 class="page-header">
                            Projects <small>Overview</small>
                        </h1>
                        <ol class="breadcrumb">
                            <li class="active">
                                <i class="fa fa-dashboard"></i> List of projects
                            </li>
                        </ol>
                    </div>
                </div>

    <form align="center" class="form-inline" action="/perfhistory/projects" method="post">
        {% csrf_token %}
        {% load css_filter %}

        {% for field in projectform %}
        <div class="form-group">
        {{ field|addcss:"form-control" }}
        </div>
        {% endfor %}

        <button type="submit" class="btn btn-primary btn-lg" value="Create {{ type }}">
            <span class="glyphicon glyphicon-plus"></span> New Project
        </button>
    </form>

<!-- <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true"> -->


<script type="text/javascript">
          $(document).ready(function() 
          {
            
                
            $("[id^=updateProjectForm_]").submit(function(e,data)
            {
                // var projectid=e.currentTarget.dataset.projectId;
                var projectid= event.currentTarget.closest(".list-group-item").attributes['data-pid'].value;
                var csrftoken = getCookie('csrftoken');

                e.preventDefault();
                formdata = {}

                for (i=0; i<e.currentTarget.length-1; i++)
                {
                    console.log(e.currentTarget[i].name, e.currentTarget[i].value)
                    if (e.currentTarget[i].value)
                        formdata[String(e.currentTarget[i].name)] = e.currentTarget[i].value
                }

                $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
                });
                // console.log('formdata->',formdata);
                // console.log(event.currentTarget.closest(".list-group-item").attributes['data-pid'].value);
                update_project(formdata);
                
                // this.reset();
            });

            $("button#yesOnDelete").on("click", function(event)
            {
                var csrftoken = getCookie('csrftoken');

                $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
                });

                projectid = event.currentTarget.closest(".list-group-item").attributes['data-pid'].value;
                delete_project(projectid);
                refresh_project_page();

            });


        });

        function update_project(data)
        {
            // var jqxhr = $.put( "/perfhistory/project/"+projectid,data )


               var jqxhr= $.ajax({
                            url: '/perfhistory/projects',
                            type:'put',
                            data: data
                            // success: function(result) {
                            //     // Do something with the result
                            // }
                        });
                jqxhr.success (function(data) 
                {

                    $('[id^=edit_]').modal('hide');
                    refresh_project_page();


                });
                jqxhr.done(function() 
                {
                    
                    // console.log("second success" );
                 });
                 jqxhr.fail(function() 
                 {
                   console.log("Error" );
                 });
                jqxhr.always(function(data) 
                {
                    // console.log("Finished" );
                    // console.log(data);
                });

        }

        function delete_project(project_Id)
        {
            // var jqxhr = $.put( "/perfhistory/project/"+projectid,data )


               var jqxhr= $.ajax({
                            url: '/perfhistory/project/'+project_Id,
                            type:'delete',
                            
                            // success: function(result) {
                            //     // Do something with the result
                            // }
                        });
                jqxhr.success (function(data) 
                {
                    // console.log("Success" );
                    console.log(data);
                    $('[id^=delete_]').modal('hide');
                    refresh_project_page();


                });
                jqxhr.done(function() 
                {
                    
                 });
                 jqxhr.fail(function() 
                 {
                 });
                jqxhr.always(function(data) 
                {

                });

        }

        function refresh_project_page()
        {
            console.log('refresh');
            // window.location.href = '/perfhistory/projects';
            // window.location.method = 'get';
            // location.reload();
            window.location.reload(true); 
                            $.ajax({
                            url: '/perfhistory/projects'
                            // type:'delete',
                            
                            // success: function(result) {
                            //     // Do something with the result
                            // }
                        });
        }


</script>

<style type="text/css">
    .pull-right {
        margin-right:1em
    }

    .modified {
        margin-right:1em
    }

</style>

<ul class="list-group">
        {% for obj in object_list %}

    <li class="list-group-item" data-pid="{{ obj.id }}"> 
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="heading_{{ obj.id }}">

                    <h4 class="panel-title">
                        <a class="collapsed" 
                            role="button" 
                            data-toggle="collapse" 
                            data-parent="#accordion" 
                            href="#collapse_{{ obj.id }}" 
                            aria-expanded="false" 
                            aria-controls="collapse_{{ obj.id }}" 
                            data-pid="{{ obj.id}}">
                            
                            <small>{{ obj.id}}. </small> {{ obj.name}} <small>{{ obj.description}}</small> 
                        </a>
                            <div class="pull-right">
                                    
                                        <small class="modified">modified: {{ obj.last_modified }}</small>
                                    
                                
                                    <button  class="btn btn-default btn-xs" data-title="Edit" data-toggle="modal" data-target="#edit_{{ obj.id }}" >
                                        <span data-placement="top" data-toggle="tooltip" title="Edit" class="glyphicon glyphicon-edit"></span>
                                    </button>
                                

                                
                                    <button  id="deleteButton" class="btn btn-danger btn-xs" data-title="Delete" data-toggle="modal" data-target="#delete_{{ obj.id }}" data-pid={{ obj.id }}>
                                        <span data-placement="top" data-toggle="tooltip" title="Delete" class="glyphicon glyphicon-trash"></span>
                                    </button>

                            </div>
                        
                    </h4>

                </div>

                <!-- /.modal-delete --> 
                    <div class="modal fade" id="delete_{{ obj.id }}" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true" style="display: none;">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
                                        <h4 class="modal-title custom_align" id="Heading">Delete this {{ type|lower }}</h4>
                                    </div>
                               
                                    <div class="modal-body">
                                    
                                        <div class="alert alert-danger"><span class="glyphicon glyphicon-warning-sign"></span> Are you sure you want to delete this {{ type|lower }}?</div>
                                    </div>
                                    <div class="modal-footer ">
                                        <button id="yesOnDelete" type="submit" class="btn btn-success">
                                            <span class="glyphicon glyphicon-ok-sign"></span>&nbsp;Yes
                                        </button>
                                        <button type="button" class="btn btn-default" data-dismiss="modal">
                                            <span class="glyphicon glyphicon-remove"></span>&nbsp;No
                                        </button>
                                    </div>
                            </div>
                        </div>
                    </div>

                    <!-- /.modal-edit --> 
                    <div class="modal fade" id="edit_{{ obj.id }}" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
                                    <h4 class="modal-title custom_align" id="Heading">Edit Project</h4>
                                </div>
                                <div class="modal-body">

                                    <form  id="updateProjectForm_{{ obj.id }}" >
                                                {% csrf_token %}
                                                <input type="hidden" name="id" value="{{ obj.id }}">
                                                <!-- {% load css_filter %}

                                                {% for field in projectform %}
                                                {{ field|addcss:"form-control" }}
                                                {% endfor %} -->
                                        
                                        <div class="form-group">

                                            <label type="text">Name:</label>
                                            <!-- {{ editprojectform.name }} -->
                                            <input id="name" name="name" class="form-control" type="text" value="{{ obj.name }}" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label  type="text">Description:</label>
                                            <!-- {{ editprojectform.name }} -->
                                            <textarea id="description" name="description" rows="2" class="form-control" >{{ obj.description }}</textarea>
                                        </div>
                                        <button type="submit" class="btn btn-warning btn-lg" style="width: 100%;">
                                        <span class="glyphicon glyphicon-ok-sign"></span> Update
                                        </button>
                                    </form>
                                    
                                </div>
                                <div class="modal-footer ">
                                    
                                </div>
                            </div>
                        </div>
                    </div>


                <div id="collapse_{{ obj.id }}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading_{{ obj.id }}">
                    <div class="panel-body">
                    
                        <ul><b>Name:</b> <a href="project/{{ obj.id }}" > {{ obj.name }} </a> </ul>
                        <ul><b>Description:</b> {{ obj.description }} </ul>
                        <ul><b>Created:</b> {{ obj.created }} </ul>
                        <ul><b>Last Modified:</b> {{ obj.last_modified }} </ul>

                            <div id="tableplaceholder">
                            </div>

                            <div id="tag_form_div">
                                <form id="tagform_{{ obj.id }}" data-project-id="{{ obj.id }}" class="form-inline" method="post" action="">
                                    <div align="center">
                                           {% csrf_token %}
                                            {% load css_filter %}

                                            {% for field in tagForm %}                        
                                            {{ field|addcss:"form-control" }}
                                            {% endfor %}

                                        <input type="submit" id="AddTagButton" class="btn btn-default" value="Add Tag"/>
                                    </div>    
                                </form>
                            </div>
                    </div>
                </div>
            </div>
    </li>

        {% endfor %}
</ul>



</div>
{% endblock %}