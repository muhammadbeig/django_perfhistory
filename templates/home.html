{% extends "base_index.html" %}
{% block content %}


    
<script type="text/javascript">

        function removeTagTable(pid)
        {
            $("#tagTable_"+pid).remove();
        }
        function createTable(pid, object_list){
             
            mytable = $('<table></table>').attr({ id: "tagTable_"+pid,class: ["table",  "table-bordered", "table-striped"].join(' ') });
            // _"+pid
            
            // var rows = 2;//new Number($("#rowcount").val());
            // var cols = 2;//new Number($("#columncount").val());
            var tr = [];
            if (object_list.length > 0)
            {
                // console.log('object_list'+object_list);
                // console.log('zero-th object'+object_list[0]["tag_name"]);
                
                $('<th></th>').text("Name").attr({ align: "center"}).appendTo(mytable);
                $('<th></th>').text("Description").attr({ align: "center"}).appendTo(mytable);    
                for (var i=0; i<object_list.length; i++)
                {
                    tagId = object_list[i]["tag_id"]
                    var row = $('<tr class="clickable-tagrow" data-tid='+tagId+' data-href="/perfhistory/project/'+pid+'/tag/'+tagId+'/result" style="cursor: pointer"></tr>').appendTo(mytable);
                    
                    // $('<a href=""></a>').appendTo(row);
                    $('<td></td>').text(object_list[i]["tag_name"]).attr({ align: "center"}).appendTo(row); 
                    $('<td></td>').text(object_list[i]["tag_description"]).attr({ align: "center"}).appendTo(row); 
                }

                // console.log("TTTTT:"+mytable.html());
                $('#collapse_'+pid).children('.panel-body').children('#tableplaceholder').append(mytable);  

            }  
          
        }


        function ajax_get_tags_in_project (project_id)
        {
            // var pid=e.currentTarget.dataset.pid;
                        // console.log(pid);
                        var jqxhr = $.get( "/perfhistory/project/"+project_id+"/getTags",function(f) 
                        {
                          // console.log('dats', f );
                          removeTagTable(project_id);
                          createTable(project_id, f);

                        })
                        .done(function(d) {
                            // console.log( d );
                        })
                        .fail(function(e) {
                            // console.log( "error",e );
                        })
                        .always(function() {
                            // console.log( "finished" );
                        });

                    // Perform other work here ...

                    // Set another completion function for the request above
                    jqxhr.always(function() {
                      // console.log( "second finished" );
                    });

                    
        }

        

        $(document).ready(function() {

            var originalColor;

                $('div#tableplaceholder').on('mouseenter', '.clickable-tagrow', function() {
                        // $(this).addClass('hover');
                        // console.log('current color:'+ $(this).css( "background" ))
                        originalColor = $(this).css( "background" )
                        $(this).css("background","");
                        $(this).css("background","lightblue");

                        // console.log("mouse enter");

                    });
                $('div#tableplaceholder').on('mouseleave', '.clickable-tagrow', function() {
                        // $(this).removeClass('hover');
                        $(this).css("background",originalColor);
                        // console.log("mouseleave");
                    });

                $("div#tableplaceholder").on('click', '.clickable-tagrow',  function() {

                    console.log("row clicked: " + $(this).data("href"));
                    href = $(this).data("href")
                    window.location.href = href
                    // $.get( href, function( data ) {
                    //       $( ".result" ).html( data );
                    //       // alert( "Load was performed." );
                    //     });
                });



        });
</script>

<script type="text/javascript">
        $(function()
        {
            $('.collapsed').on('click', function(event)
                { ajax_get_tags_in_project(event.currentTarget.dataset.pid)});

        });


          $(document).ready(function() 
          {
            
                
            $("[id^=tagform_]").submit(function(e,data)
            {
                var projectid=e.currentTarget.dataset.projectId;
                var csrftoken = getCookie('csrftoken');

                e.preventDefault();
                formdata = {}
                for (i=0; i<e.currentTarget.length-1; i++)
                {
                    if (e.currentTarget[i].value)
                        formdata[String(e.currentTarget[i].name)] = e.currentTarget[i].value
                }

                $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
                });
                create_tag(projectid, formdata);
                this.reset();
            });

        });

        function create_tag(projectid, data)
        {
            var jqxhr = $.post( "/perfhistory/project/"+projectid+"/createTag",data )

                jqxhr.success (function(data) 
                {
                    // console.log("Success" );
                    // console.log(data);
                    
                    if (data['result'])
                    {
                        var projectid=data['project_id']
                        removeTagTable(projectid)
                        ajax_get_tags_in_project(projectid);

                    }


                });
                jqxhr.done(function() 
                {
                    
                    // console.log("second success" );
                 });
                 jqxhr.fail(function() 
                 {
                   // console.log("Error" );
                 });
                jqxhr.always(function(data) 
                {
                    // console.log("Finished" );
                    // console.log(data);
                });
        }
            

        function getCookie(name) 
        {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function csrfSafeMethod(method) 
        {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }        
</script>




<div id="page-wrapper">

                <!-- Page Heading -->
                <div class="row">
                    <div class="col-lg-12">
                        <h1 class="page-header">
                            Projects <small>Overview</small>
                        </h1>
                        <ol class="breadcrumb">
                            <li class="active">
                                <i class="fa fa-dashboard"></i> Dashboard
                            </li>
                        </ol>
                    </div>
                </div>


<!-- <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true"> -->




<ul class="list-group">
        {% for obj in object_list %}

    <li class="list-group-item"> 
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="heading_{{ obj.id }}">

                    <h4 class="panel-title">
                        <a class="collapsed" 
                            role="button" 
                            data-toggle="collapse" 
                            data-parent="#accordion" 
                            href="#collapse_{{ obj.id }}" 
                            aria-expanded="false" 
                            aria-controls="collapse_{{ obj.id }}" 
                            data-pid="{{ obj.id}}">
                            
                            <small>{{ obj.id}}. </small> {{ obj.name}} <small>{{ obj.description}}</small>
                        </a>
                    </h4>
                </div>



                <div id="collapse_{{ obj.id }}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading_{{ obj.id }}">
                    <div class="panel-body">
                    
                        <ul><b>Name:</b> <a href="project/{{ obj.id }}" > {{ obj.name }} </a> </ul>
                        <ul><b>Description:</b> {{ obj.description }} </ul>
                        <ul><b>Created:</b> {{ obj.created }} </ul>
                        <ul><b>Last Modified:</b> {{ obj.last_modified }} </ul>

                            <div id="tableplaceholder">
                            </div>

                            <div id="tag_form_div">
                                <form id="tagform_{{ obj.id }}" data-project-id="{{ obj.id }}" class="form-inline" method="post" action="">
                                    <div align="center">
                                           {% csrf_token %}
                                            {% load css_filter %}

                                            {% for field in tagForm %}                        
                                            {{ field|addcss:"form-control" }}
                                            {% endfor %}

                                        <input type="submit" id="AddTagButton" class="btn btn-default" value="Add Tag"/>
                                    </div>    
                                </form>
                            </div>
                    </div>
                </div>
            </div>
    </li>

        {% endfor %}
</ul>


<script type="text/javascript">
    $(document).ready(function() {
        $('#example').DataTable();
    } );
</script>

<table id="example" class="display" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Description</th>
                <th>Created</th>
                <th>Modified</th>                
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Description</th>
                <th>Created</th>
                <th>Modified</th>
            </tr>
        </tfoot>
        <tbody>
        {% for obj in object_list %}
            <tr>
                <td>{{ obj.id }}</td>
                <td>{{ obj.name }}</td>
                <td>{{ obj.description }}</td>
                <td>{{ obj.created }}</td>
                <td>{{ obj.last_modified }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css">


</div>
{% endblock %}